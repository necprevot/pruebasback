<h2>Productos en Tiempo Real</h2>

<div id="status" class="mb-3">
    <span id="connectionStatus" style="color: orange;">Conectando...</span>
</div>

{{#if success}}
    <div class="alert alert-success">
        {{success}}
    </div>
{{/if}}

{{#if error}}
    <div class="alert alert-danger">
        {{error}}
    </div>
{{/if}}

<h3>Agregar Nuevo Producto</h3>
<form id="productForm">
    <div class="form-group">
        <label for="title">Título:</label>
        <input type="text" id="title" name="title" required>
    </div>
    
    <div class="form-group">
        <label for="description">Descripción:</label>
        <textarea id="description" name="description" required></textarea>
    </div>
    
    <div class="form-group">
        <label for="price">Precio:</label>
        <input type="number" id="price" name="price" min="0" step="1" required>
    </div>
    
    <div class="form-group">
        <label for="status">Estado:</label>
        <select id="status" name="status" required>
            <option value="">Selecciona un estado</option>
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="stock">Stock:</label>
        <input type="number" id="stock" name="stock" min="0" required>
    </div>
    
    <div class="form-group">
        <label for="category">Categoría:</label>
        <input type="text" id="category" name="category" required>
    </div>
    
    <div class="form-group">
        <label for="thumbnails">Imágenes (nombres de archivo separados por comas):</label>
        <input type="text" id="thumbnails" name="thumbnails" placeholder="cerezas.png, chucrut.jpg">
        <small>Solo ingresa el nombre del archivo. Las imágenes deben estar en public/img/</small>
    </div>
    
    <button type="submit" class="btn-primary">Agregar Producto</button>
</form>

<hr>

<h3>Lista de Productos</h3>
<div id="productsList">
    <!-- Los productos se cargarán aquí dinámicamente -->
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const productsList = document.getElementById('productsList');
    const connectionStatus = document.getElementById('connectionStatus');
    const productForm = document.getElementById('productForm');

    // Manejo de conexión
    socket.on('connect', () => {
        console.log('Conectado al servidor');
        connectionStatus.textContent = 'Conectado ✓';
        connectionStatus.style.color = 'green';
    });

    socket.on('disconnect', () => {
        console.log('Desconectado del servidor');
        connectionStatus.textContent = 'Desconectado ✗';
        connectionStatus.style.color = 'red';
    });

    // Recibir productos actualizados
    socket.on('updateProducts', (products) => {
        console.log('Productos actualizados:', products);
        renderProducts(products);
    });

    // Función para renderizar productos
    function renderProducts(products) {
        if (!products || products.length === 0) {
            productsList.innerHTML = '<p>No hay productos disponibles.</p>';
            return;
        }

        const productsHTML = products.map(product => `
            <div style="border: 1px solid #ccc; margin: 10px 0; padding: 10px; border-radius: 5px;">
                <h4>${product.title} - ${product.price}</h4>
                <p>${product.description}</p>
                <small>
                    Stock: ${product.stock} | 
                    Categoría: ${product.category} | 
                    Estado: ${product.status ? 'Activo' : 'Inactivo'} | 
                    Código: ${product.code}
                </small>
                ${product.thumbnails && product.thumbnails.length > 0 ? 
                    `<br><div style="margin: 10px 0;">
                        ${product.thumbnails.map(img => 
                            `<img src="${img}" alt="${product.title}" style="width: 80px; height: 80px; object-fit: cover; margin: 5px; border: 1px solid #ddd; border-radius: 3px;" onerror="this.style.display='none';">`
                        ).join('')}
                    </div>` : ''}
                <br>
                <button onclick="deleteProduct(${product.id})" 
                        style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-top: 5px;">
                    Eliminar
                </button>
            </div>
        `).join('');

        productsList.innerHTML = productsHTML;
    }

    // Función para eliminar producto
    window.deleteProduct = function(productId) {
        if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
            socket.emit('deleteProduct', productId);
        }
    }

    // Manejo del formulario
    productForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(productForm);
        const thumbnails = formData.get('thumbnails');
        
        // Procesar thumbnails para convertir nombres de archivo a rutas
        const thumbnailsArray = thumbnails ? 
            thumbnails.split(',')
                .map(filename => filename.trim())
                .filter(filename => filename)
                .map(filename => `/img/${filename}`) : 
            [];
        
        const productData = {
            title: formData.get('title'),
            description: formData.get('description'),
            price: parseInt(formData.get('price')),
            status: formData.get('status') === 'true',
            stock: parseInt(formData.get('stock')),
            category: formData.get('category'),
            thumbnails: thumbnailsArray
        };

        socket.emit('addProduct', productData);
        productForm.reset();
    });

    // Manejo de errores
    socket.on('error', (error) => {
        alert('Error: ' + error.message);
    });
</script>